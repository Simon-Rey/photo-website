
{% assign photos = site.data[include.name] | sort: 'order_index' %}
{% assign photoDiv1 = '' | split: '' %}
{% assign photoDiv2 = '' | split: '' %}
{% assign photoDiv3 = '' | split: '' %}
{% assign total_height1 = 0 %}
{% assign total_height2 = 0 %}
{% assign total_height3 = 0 %}

{% for photo in photos %}
  {% if total_height1 <= total_height2 and total_height1 <= total_height3 %}
    {% assign photoDiv1 = photoDiv1 | push: photo %}
    {% assign total_height1 = total_height1 | plus: photo.normalised_height %}
  {% elsif total_height2 <= total_height1 and total_height2 <= total_height3 %}
    {% assign photoDiv2 = photoDiv2 | push: photo %}
    {% assign total_height2 = total_height2 | plus: photo.normalised_height %}
  {% else %}
    {% assign photoDiv3 = photoDiv3 | push: photo %}
    {% assign total_height3 = total_height3 | plus: photo.normalised_height %}
  {% endif %}
{% endfor %}

{% assign allPhotoDivs = '' | split: '' %}
{% assign allPhotoDivs = allPhotoDivs | push: photoDiv1 %}
{% assign allPhotoDivs = allPhotoDivs | push: photoDiv2 %}
{% assign allPhotoDivs = allPhotoDivs | push: photoDiv3 %}

<div class="gallery-wrap">
  {% for photoDiv in allPhotoDivs %}
    <div>
      {% for photo in photoDiv %}
          <img class="photo-thumbnail" src="{{ site.baseurl }}/assets/galleries/{{ photo.src-small }}"
               {% if photo.alt %} alt="{{ photo.alt }}"{% endif %}
               data-orderindex = {{ photo.order_index| plus: -1 }}
          >
      {% endfor %}
    </div>
  {% endfor %}
</div>

<div id="modal" class="modal">
    <img class="modal-content" id="modal-image" alt="" src="">
    <a class="modal-control modal-prev" id="modal-prev">&#10094;</a>
    <a class="modal-control modal-next" id="modal-next">&#10095;</a>
    <span id="modal-close" class="close">&times;</span>
    <div id="modal-details-box" class="modal-details-box"></div>
</div>

<script>
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-image');
    const modalControls = document.querySelectorAll('.modal-control');
    const modalPrev = document.getElementById('modal-prev');
    const modalNext = document.getElementById('modal-next');
    const modalClose = document.getElementById('modal-close');
    const modalDetails = document.getElementById('modal-details-box');
    const galleryImages = document.querySelectorAll('.photo-thumbnail');
    let currentSlideIndex = 0;
    let photoSrcs = [
        {% for photo in photos %} "{{ site.baseurl }}/assets/galleries/{{ photo.src-large }}",
        {% endfor %}
    ]; // Array to store image source URLs
    let photoDetails = [
        {% for photo in photos %} "{% if photo.title %}{{ photo.title }}{% if photo.caption %} &ndash; {% endif %}{% endif %}{% if photo.caption %}{{ photo.caption }}{% endif %}",
        {% endfor %}
    ];

    function preloadImages() {
        photoSrcs.forEach((src) => {
            const img = new Image();
            img.src = src;
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        preloadImages(); // Preload images when the DOM is ready
    });

    galleryImages.forEach((image) => {
        image.addEventListener('click', () => {
            showModal();
            showPhoto(parseInt(image.dataset.orderindex));
        });
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('close')) {
            hideModal();
        }
    });

    modalImg.addEventListener('load', function() {
        modalControls.forEach( (c) => {
            c.classList.add('hidden');
        });
    });

    modalPrev.addEventListener('click', () => {
        showPhoto(-1);
    });

    modalNext.addEventListener('click', () => {
        showPhoto(1);
    });

    function showModal() {
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden'; // Hide the scrollbar
    }

    function hideModal() {
        modal.classList.remove('visible');
        document.body.style.overflow = 'auto'; // Restore the scrollbar
        modalPrev.classList.remove('hidden');
        modalNext.classList.remove('hidden');
        modalImg.src = "";
    }

    function showPhoto(n) {
        if (n >= photoSrcs.length) {
            n = 0;
        }
        if (n < 0) {
            n = photoSrcs.length - 1;
        }
        currentSlideIndex = n;
        modalImg.src = photoSrcs[n];
        const details = photoDetails[n];
        if (details) {
            modalDetails.innerHTML = "<p>" + details + "</p>"
            modalDetails.classList.add('visible');
        } else if (modalDetails.classList.contains('visible')) {
            modalDetails.classList.remove('visible');
        }
    }

    document.addEventListener('keydown', (e) => {
        if (modal.classList.contains('visible')) {
            if (e.key === 'ArrowLeft' || e.keyCode === 37) {
                showPhoto(currentSlideIndex - 1);
            } else if (e.key === 'ArrowRight' || e.keyCode === 39) {
                showPhoto(currentSlideIndex + 1);
            } else if (e.key === 'Escape' || e.keyCode === 27) {
                hideModal();
            }
        }
    });

    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', e => {
        if (modal.classList.contains('visible')) {
            touchStartX = e.changedTouches[0].screenX
        }
    })

    document.addEventListener('touchend', e => {
        if (modal.classList.contains('visible')) {
            if (e.target === modalClose) {
                hideModal();
            }
            touchEndX = e.changedTouches[0].screenX
            updateOnSwipe()
        }
    })
    function updateOnSwipe() {
        const diff = touchEndX - touchStartX
        if (diff < -50) {
            showPhoto(-1); // Trigger plusSlides(-1) when the user slides to the right
        } else if (diff > 50) {
            showPhoto(1); // Trigger plusSlides(1) when the user slides to the left
        }
    }
</script>